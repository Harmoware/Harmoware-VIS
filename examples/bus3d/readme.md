# Harmoware-VIS/examples/bus3d
Harmoware-VIS を使用し、バスの運行情報およびバス停位置情報と、XBANDによる雨量情報を同時に可視化するアプリケーションのサンプルです。
## Using visualize-sample
### Mapbox Accesstoken Setting
[mapbox.com](https://www.mapbox.com/ "mapbox.com") から Accesstoken を取得してください。
これを環境変数を設定してください。
```
#!shell
 set MAPBOX_ACCESS_TOKEN=XXXXXXXXX
```
## Run visualize-sample
```
#!shell
npm run bus3d
```
## Using data
### バス運行データ
バス運行データファイルは「./data/」フォルダに **shift_jis コード** で作成してください。
また、作成するファイル名は以下のき命名規則に従ってください。
```
xxxxx-YYYYMMDD.(csv/json)
```
ｘｘｘｘｘ：識別名　ハイフンを含まない英数字で指定してください。
ＹＹＹＹＭＭＤＤ：シュミレーション日時　"timeBegin"の日付と一致させてください。

運行データには"csv"形式が１種類と、"json"形式が２種類あります。
#### "csv"形式 データフォーマット
```csv
１行目：路線コード,系統コード,上下,系統表示名,ダイヤＩＤ,並び順,停留所コード,所定発時刻,実績発時刻
２行目：6801,680101,1,東岡崎～梅園学校前～フタバ産業前,11299,1,4101,07:08,07:08:34
　：
```
データは同一ダイヤＩＤ毎に設定してください。
また到着順序は「並び順」として昇順に並んでいる必要があります。
#### "json"形式（その１） データフォーマット
```js
{   "timeBegin":9999999999, //運行シュミレーション開始日時（UNIX時間（秒））
    "timeLength": 99999, //運行シュミレーション開始から終了までの経過時間（秒）
    "bounds": [ //運行シュレーション範囲
        999.99999, //西端経度
        99.9999, //南端緯度
        999.99999, //東端経度
        99.9999 ], //北端緯度
    "trips":[ //運行シュミレーションデータ
        {  "segments": [ //運行単位（１便）ごとに時間と経路を定義する
                [ //経過時間順に定義する
                    99999, //timeBeginからの経過時間
                    999.9999, //位置（経度）
                    99.999 //位置（緯度）
                ],・・・・・・
            ],・・・・・・
            "color": [ //segmentsの要素に対応する色を指定する（segmentsの要素数と同じ数で指定）
                [rrr,ggg,bbb], //rgb
            ],・・・・・・
        },・・・・・・
    ]
}
```
#### "json"形式（その２） データフォーマット
```js
{   "timeBegin":9999999999, //運行シュミレーション開始日時（UNIX時間（秒））
    "timeLength": 99999, //運行シュミレーション開始から終了までの経過時間（秒）
    "bounds": { //運行シュレーション範囲
        "southlatitude": 99.9999, //南端緯度
        "northlatitude": 99.9999, //北端緯度
        "westlongitiude": 999.99999, //西端経度
        "eastlongitiude": 999.99999 }, //東端経度
    "busmovesbase":[ //運行シュミレーションデータ
        { //運行単位（１便）ごとに時間と経路を定義する
            "departuretime": 99999,
            "arrivaltime": 99999,
            "busclass": { //運行単位（１便）ごとの属性
                "diagramid": 99999, //ダイヤＩＤ
                "systemcode": 999999, //系統コード
                "systemname": "系統表示名", //系統表示名
                "direction": 9, //上下コード（1 or 2）
                "timetable": "99:99" //時刻表時刻
            },
            "operation": [ //運行単位（１便）ごとに時間と経路を定義する
                { //経過時間順に定義する
                    "elapsedtime": 99999, //timeBeginからの経過時間
                    "longitude": 999.9999, //位置（経度）
                    "latitude": 99.999, //位置（緯度）
                    "color": [rrr,ggg,bbb], //rgb
                    "delaysec": 99999, //遅延時間（秒）
                    "busprop": { //オプションデータ（省略可）
                        "elevation": 999 or [999,・・・・・・],
                        "color": [rrr,ggg,bbb] or [[rrr,ggg,bbb],・・・・・・],
                        "memo": "表示する文字列"
                    }
                },・・・・・・
            ]
        },・・・・・・
    ],
    "busmovesbasedic":{ //運行シュミレーションデータ検索辞書（busmovesbaseの要素数と同じ数で指定）
        {  (ダイヤＩＤ(number)): (対応するbusmovesbaseのデータのindex値(number))
        },・・・・・・
    }
}
```
### バス運行データリスト
バス運行データリストは「bus3d」フォルダ直下にファイル名「datalist.json」で作成してください。
#### ファイルデータフォーマット
```js
{   "children": [
        {file: (運行データファイル名)},・・・・・・
    ],
    "leading": 99999 //シュミレーション開始前余白時間（秒）（省略可能　規定値＝100）
}
```
### バス停データ
バス停データファイルは「./BusStopsData/」フォルダにファイル名「busstops.csv」で作成してください。
#### ファイルデータフォーマット
```js
1行目：停留所コード,停留所名,緯度,経度
2行目：0001,バスセンター,35.168366,136.884123
　：
```
バス停データ内のバス停データから、バス運行データシュミレーション範囲のものを抽出して表示します。
### 系統毎バス停定義データ
バス運行データがcsv形式の場合のバス停間経路探索で使用します。

系統毎バス停定義データファイルは「./routes/」フォルダにファイル名「busroutes.json」で作成してください。
#### ファイルデータフォーマット
```js
{
    (系統コード-上下コード(number)): [ //系統コード-上下コードの全パターンを定義する(number) （例: 1810114-1 ）
        (バス停コード(number)),・・・・・・ //バス停コードを停車順に定義する(number) （例: 4101 ）
    ]、・・・・・・
}
```
### 経路データ
バス運行データがcsv形式の場合のバス停間経路探索で使用します。

経路データファイルは「./routes/」フォルダにファイル名「routes.json」で作成してください。
#### ファイルデータフォーマット
```js
{   "dep_station_code": [ //始点バス停コード
        (始点バス停コード(number)),・・・・・・ //始点バス停コードを定義する(number) （例: 4101 ）
    ],
    "des_station_code": [ //終点バス停コード
        (終点バス停コード(number)),・・・・・・ //終点バス停コードを定義する(number) （例: 4101 ）
    ],
    "route": [ //経路データ
        (経路データ(json文字列)),・・・・・・ //経路データを定義する(json文字列)
        （例: "{ \"result\": \"success\", //経路データ有無 "success"固定
                \"distance\": 999.99999, //始点→終点の距離（ｍ）
                \"route\": [
                    [99.99999, //経路間緯度
                    999.99999, //経路間経度
                    0.0, //始点からの距離
                    0.0, //始点から終点の距離を1.0とした割合
                    0 //index
                    ],・・・・・・]}" ）
    ],
}
```
dep_station_code[n] → des_station_code[n] の経路が route[n] となります。
routeデータの最初は始点バス停位置と、最後は終点バス停位置と同じです。
### 拡張情報データ
バス運行アイコン及びバス停アイコンに拡張情報を反映する立体グラフを付加します。

| optionキー名 | 拡張情報表示説明 |
| :------------ | :------------ |
| busmovesoption | バス運行アイコンに立体グラフを付加 |
| busstopsoption | バス停アイコンに立体グラフを付加 |
| archoption | バス停間にアーチを表示 |

拡張情報データファイルは「./BusStopsData/」フォルダに作成してください。
また、作成するファイル名は以下のき命名規則に従ってください。
```
xxxxx-YYYYMMDD-option.json
```
ｘｘｘｘｘ－ＹＹＹＹＭＭＤＤ：対応するバス運行データのファイル名と同じにします。
#### ファイルデータフォーマット
```js
{   "busmovesoption": { //省略可能
        (ダイヤＩＤ(number)): {
            (バス停コード(number)): { //オプションデータ
                "elevation": 999 or [999,・・・・・・], //省略可能
                "color": [rrr,ggg,bbb] or [[rrr,ggg,bbb],・・・・・・], //省略可能
                // elevation と color は定義位置で同期します。
                "memo": "表示する文字列" //省略可能
            },・・・・・・
        },・・・・・・
    },
    "busstopsoption": { //省略可能
        (経過時間(number)): [ //timeBeginからの経過時間
            {   "bscode": (バス停コード(number)),
                "elevation": 999 or [999,・・・・・・], //省略可能
                "color": [rrr,ggg,bbb] or [[rrr,ggg,bbb],・・・・・・], //省略可能
                // elevation と color は定義位置で同期します。
                "memo": "表示する文字列" //省略可能
            },・・・・・・
        ],・・・・・・
    },
    "archoption": [ //省略可能
        {   "diagramId": "99999", // ダイヤＩＤ
            "sourceDepotsCode": "999", // 起点バス停コード
            "sourceDepotsOrder": "9", // 起点バス停コード順序
            "sourceColor": [rrr, ggg, bbb, [aaa]], // 起点色指定(省略可)
            "targetDepotsCode": "999", // 終点バス停コード
            "targetDepotsOrder": "9", // 終点バス停コード順序
            "targetColor": [rrr, ggg, bbb, [aaa]], // 終点色指定(省略可)
            "color": [rrr, ggg, bbb, [aaa]], // 色指定(省略可) 起点終点色指定が優先
            "strokeWidth": 99, // 線幅指定(メーター)
            "memo": "表示する文字列" //省略可能
        },・・・・・・
    ]
}
```
### xband雨量情報データ
xband雨量情報データを基に雨量を反映する立体グラフを付加します。

拡張情報データファイルは「./GridCellLayerData/」フォルダに作成してください。
また、作成するファイル名は以下のき命名規則に従ってください。
```
xxxxx-YYYYMMDD-HHMM.json
```
ｘｘｘｘｘ：識別名　対応するバス運行データのファイル名の識別名と同じにします。
ＹＹＹＹＭＭＤＤ－ＨＨＭＭ：日時　雨量情報データの該当する日時
#### ファイルデータフォーマット
```js
[   {   "position": [999.9999, 99.9999], //オブジェクト表示する位置（経度、緯度）
        "color": [rrr,ggg,bbb], //オブジェクト表示色
        "elevation": 999.9 //雨量情報
    },・・・・・・
]
```
